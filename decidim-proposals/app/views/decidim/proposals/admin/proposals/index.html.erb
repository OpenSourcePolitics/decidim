<div class="card with-overflow">
  <div class="card-divider">
    <h2 class="card-title flex--sbc">
      <div>
        <%= t(".title") %>
        <span id="js-selected-proposals-count" class="component-counter component-counter--inline" title="<%= t("decidim.proposals.admin.proposals.index.selected") %>"></span>
      </div>
      <%= render partial: "bulk-actions" %>
    </h2>
  </div>
  <div class="filters__section">
    <div class="fcell filter">
      <ul class="dropdown menu" data-dropdown-menu data-close-on-click-inside="false">
        <li class="is-dropdown-submenu-parent">
          <a href="#" class="dropdown button">
            <%= t("decidim.admin.actions.filter") %>
          </a>
          <ul class="nested vertical menu" data-close-on-click-inside="false">
            <li class="is-dropdown-submenu-parent">
              <a href="#"><%= t("models.proposal.fields.state", scope: "decidim.proposals") %></a>
              <ul class="nested vertical menu">
                <% filter_admin_state_values.each do |state| %>
                  <li><%= link_to (humanize_proposal_state state), q: merge_query(state_eq: state) %></li>
                <% end %>
              </ul>
            </li>
            <li class="is-dropdown-submenu-parent">
              <a href="#"><%= t("models.proposal.fields.category", scope: "decidim.proposals") %></a>
              <ul class="nested vertical menu">
                <% categories_for_select(categories).each do |category| %>
                  <li><%= link_to category[0], q: merge_query(category_id_eq: category[1]) %></li>
                <% end %>
              </ul>
            </li>
          </ul>
        </li>
      </ul>
    </div>
    <div class="fcell search">
      <%= search_form_for query do |f| %>
        <% if params[:q] %>
          <% if params[:q][:state_eq] %>
            <%= hidden_field_tag "q[state_eq]", params[:q][:state_eq]  %>
          <% end %>
          <% if params[:q][:category_id_eq] %>
            <%= hidden_field_tag "q[category_id_eq]", params[:q][:category_id_eq]  %>
          <% end %>
        <% end %>
        <div class="input-group">
          <%= f.search_field :title_or_body_cont,label: false, class: "input-group-field", placeholder: t("decidim.admin.impersonatable_users.index.search") %>
          <div class="input-group-button">
            <button type="submit" class="button button--muted">
              <%= icon "magnifying-glass", aria_label: t("decidim.admin.impersonatable_users.index.search") %>
            </button>
          </div>
        </div>
      <% end %>
    </div>
    <% if params[:q] %>
      <div class="fcell status">
        <% if params[:q][:state_eq] %>
          <span class="label secondary">
            <%= t("models.proposal.fields.state", scope: "decidim.proposals") %> :
            <%= humanize_proposal_state params[:q][:state_eq] %>
            <%= icon_link_to "circle-x", url_for(q: drop_query(:state_eq)), t("decidim.admin.actions.cancel"), class: "action-icon--remove" %>
          </span>
        <% end %>
        <% if params[:q][:category_id_eq] %>
          <span class="label secondary">
            <%= t("models.proposal.fields.category", scope: "decidim.proposals") %> :
            <%= translated_attribute categories.find(params[:q][:category_id_eq]).name %>
            <%= icon_link_to "circle-x", url_for(q: drop_query(:category_id_eq)), t("decidim.admin.actions.cancel"), class: "action-icon--remove" %>
          </span>
        <% end %>
      </div>
    <% end %>
  </div>
  <div class="card-section">
    <div class="table-scroll">
      <table class="table-list">
        <thead>
          <tr>
            <th>
              <%= check_box_tag "proposals_bulk", "all", false, class: "js-check-all" %>
            </th>
            
            <% if component_settings.amendments_enabled %>
              <th>
                <%= sort_link(query, :id, t("proposals.filters.amendment_type", scope: "decidim.proposals") ) %>
              </th>
              <th></th>
            <% end %>

            <th>
              <%= sort_link(query, :id, t("models.proposal.fields.id", scope: "decidim.proposals"), default_order: :desc ) %>
            </th>
            <th>
              <%= sort_link(query, :title, t("models.proposal.fields.title", scope: "decidim.proposals") ) %>
            </th>

            <% unless params[:q] && params[:q][:category_id_eq] %>
              <th>
                <%= sort_link(query, :category_name, t("models.proposal.fields.category", scope: "decidim.proposals") ) %>
              </th>
            <% end %>

            <% if current_participatory_space.scopes_enabled? %>
              <th>
                <%= sort_link(query, :scope_name, t("models.proposal.fields.scope", scope: "decidim.proposals") ) %>
              </th>
            <% end %>

            <% unless params[:q] && params[:q][:state_eq] %>
              <th>
                <%= sort_link(query, :state, t("models.proposal.fields.state", scope: "decidim.proposals") ) %>
              </th>
            <% end %>
            
            <% if current_settings.votes_enabled? %>
              <th>
                <%= sort_link(query, :proposal_votes_count, t("models.proposal.fields.votes", scope: "decidim.proposals") ) %>
              </th>
            <% end %>

            <% if current_component.settings.comments_enabled? and !current_settings.comments_blocked? %>
              <th>
                <%= sort_link(query, :commentable_comments_count, t("models.proposal.fields.comments", scope: "decidim.proposals") ) %>
              </th>
            <% end %>

            <% if allowed_to? :create, :proposal_note %>
              <th>
                <%= sort_link(query, :proposal_notes_count, t("models.proposal.fields.notes", scope: "decidim.proposals") ) %>
              </th>
            <% end %>

            <th>
              <%= sort_link(query, :published_at, t("models.proposal.fields.published_at", scope: "decidim.proposals") ) %>
            </th>

            <th class="actions"><%= t("actions.title", scope: "decidim.proposals") %></th>
          </tr>
        </thead>
        <tbody>
          <% proposals.each do |proposal| %>
            <%= render partial: "proposal-tr", locals: { proposal: proposal } %>
          <% end %>
        </tbody>
      </table>
      <%= paginate proposals, theme: "decidim" %>
    </div>
  </div>
</div>

<%= javascript_include_tag "decidim/proposals/admin/proposals" %>
